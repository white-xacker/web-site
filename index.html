<!DOCTYPE html>
<html>
<head>
    <title>QR Check</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body style="background: #222; color: #fff; font-family: sans-serif; padding: 20px;">
    <div id="debug-box">
        <h3>Tizim holati:</h3>
        <p id="step1">1. Kutubxona yuklanmoqda...</p>
        <p id="step2">2. URL'dan ID olinmoqda...</p>
        <p id="step3">3. Supabase'ga so'rov yuborilmoqda...</p>
    </div>

    <script>
        async function init() {
            const s1 = document.getElementById('step1');
            const s2 = document.getElementById('step2');
            const s3 = document.getElementById('step3');

            try {
                // 1. Kutubxonani tekshirish
                if (typeof supabase === 'undefined') {
                    s1.innerHTML = "❌ Kutubxona yuklanmadi! Internetni tekshiring.";
                    return;
                }
                s1.innerHTML = "✅ Kutubxona tayyor.";

                // 2. ID ni tekshirish
                const params = new URLSearchParams(window.location.search);
                const id = params.get('id');
                if (!id) {
                    s2.innerHTML = "❌ URL'da ID yo'q! (Namuna: ?id=card001)";
                    return;
                }
                s2.innerHTML = `✅ ID topildi: ${id}`;

                // 3. Supabase ulanishi
                const SB_URL = "SIZNING_URL"; 
                const SB_KEY = "SIZNING_KEY";
                
                // createClient funksiyasini chaqirish
                const client = supabase.createClient(SB_URL, SB_KEY);
                
                s3.innerHTML = "⏳ Baza bilan aloqa o'rnatilmoqda...";

                // single() o'rniga oddiy select ishlatamiz (xavfsizroq)
                const { data, error } = await client
                    .from('users')
                    .select('*')
                    .eq('id', id);

                if (error) {
                    s3.innerHTML = `❌ Baza xatosi: ${error.message}`;
                    console.error(error);
                } else {
                    if (data && data.length > 0) {
                        s3.innerHTML = "✅ Karta band! Profilga o'tilmoqda...";
                        setTimeout(() => window.location.href = `profile.html?id=${id}`, 1000);
                    } else {
                        s3.innerHTML = "✅ Karta bo'sh! Ro'yxatdan o'tishga o'tilmoqda...";
                        setTimeout(() => window.location.href = `register.html?id=${id}`, 1000);
                    }
                }
            } catch (err) {
                s3.innerHTML = `❌ Kutilmagan xato: ${err.message}`;
            }
        }

        init();
    </script>
</body>
</html>