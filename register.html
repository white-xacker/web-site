<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ro'yxatdan o'tish</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background:#111; color:white; font-family:sans-serif; display:flex; justify-content:center; align-items:center; min-height:100vh; margin:0; }
        .card { background:#222; padding:30px; border-radius:20px; width:320px; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.5); }
        input { width:100%; padding:12px; margin:10px 0; background:#333; border:1px solid #444; color:white; border-radius:10px; box-sizing:border-box; }
        .btn { width:100%; padding:15px; background:#00d2ff; border:none; border-radius:10px; cursor:pointer; font-weight:bold; margin-top:10px; }
    </style>
</head>
<body>
    <div class="card">
        <h2>Ma'lumotlar</h2>
        <input type="text" id="name" placeholder="Ismingiz">
        <input type="tel" id="phone" placeholder="Telefon">
        <input type="text" id="telegram" placeholder="Telegram username">
        <input type="file" id="photo" accept="image/*">
        <button class="btn" id="sbtn" onclick="save()">SAQLASH</button>
    </div>

    <script>
        const SB_URL = "https://vakuoatitkvxgkkyhzyi.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZha3VvYXRpdGt2eGdra3loenlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3OTY3MjgsImV4cCI6MjA4NjM3MjcyOH0.-gERCw7PtwYZLM78SMs7_OLM5tLkaM8qVpmmQ_joMEo";
        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        async function save() {
            const id = new URLSearchParams(window.location.search).get('id');
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            const telegram = document.getElementById('telegram').value.replace('@','');
            const photo = document.getElementById('photo').files[0];

            if(!id || !name || !photo) return alert("To'liq to'ldiring!");

            document.getElementById('sbtn').innerText = "Yuklanmoqda...";
            
            const path = `avatars/${id}_${Date.now()}`;
            await _supabase.storage.from('avatars').upload(path, photo);
            const { data: url } = _supabase.storage.from('avatars').getPublicUrl(path);

            await _supabase.from('users').upsert([{ id, name, phone, telegram, image_url: url.publicUrl }]);
            window.location.replace("profile.html?id=" + id);
        }
    </script>
</body>
</html>