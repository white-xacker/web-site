<div id="upload-section">
    <label for="fileInput" style="display:block; margin-bottom:10px; font-size:14px;">Profil rasmini tanlang:</label>
    <input type="file" id="fileInput" accept="image/*">
</div>
<p style="text-align: center; margin: 10px 0; font-size: 12px; opacity: 0.6;">yoki</p>
<button type="button" id="skipBtn" style="background: rgba(255,255,255,0.1); margin-bottom: 15px;">Rasmsiz davom etish</button>

<script>
    // Formani saqlash qismidagi o'zgarish
    const fileInput = document.getElementById('fileInput');
    const skipBtn = document.getElementById('skipBtn');
    let finalImageUrl = "https://via.placeholder.com/150"; // Standart rasm

    // Rasm yuklash funksiyasi
    async function uploadImage(file) {
        const fileName = `${Date.now()}_${file.name}`;
        const { data, error } = await supabase.storage
            .from('avatars')
            .upload(fileName, file);
        
        if (error) throw error;
        
        const { data: publicUrl } = supabase.storage
            .from('avatars')
            .getPublicUrl(fileName);
        
        return publicUrl.publicUrl;
    }

    document.getElementById('regForm').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btn');
        btn.disabled = true;
        btn.innerText = "Yuklanmoqda...";

        try {
            // Agar fayl tanlangan bo'lsa, yuklaymiz
            if (fileInput.files.length > 0) {
                finalImageUrl = await uploadImage(fileInput.files[0]);
            }

            const { error } = await supabase.from('users').insert([{
                id: cardId,
                name: document.getElementById('name').value,
                phone: document.getElementById('phone').value,
                telegram: document.getElementById('telegram').value,
                image_url: finalImageUrl
            }]);

            if (error) throw error;
            window.location.href = `profile.html?id=${cardId}`;

        } catch (err) {
            alert("Xatolik yuz berdi: " + err.message);
            btn.disabled = false;
            btn.innerText = "Saqlash";
        }
    };

    // Skip tugmasi bosilganda file inputni tozalash
    skipBtn.onclick = () => {
        fileInput.value = "";
        alert("Rasm yuklash bekor qilindi. Standart rasm ishlatiladi.");
    };
</script>