document.getElementById('regForm').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('btn');
    btn.disabled = true;
    btn.innerText = "Saqlanmoqda...";

    // Maydonlardan ma'lumotlarni olish
    const name = document.getElementById('name').value;
    const phone = document.getElementById('phone').value;
    const telegram = document.getElementById('telegram').value.replace('@','');

    // DIQQAT: URL backtick (`) belgilari ichida bo'lishi kerak
    const img = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random&size=200`;

    try {
        const { error } = await supabase
            .from('users')
            .insert([
                { 
                    id: cardId, 
                    qr_code: cardId, 
                    name: name, 
                    phone: phone, 
                    telegram: telegram, 
                    image_url: img 
                }
            ]);

        if (error) {
            alert("Xatolik: " + error.message + "\nKod: " + error.code);
            console.error(error);
            btn.disabled = false;
            btn.innerText = "SAQLASH";
        } else {
            alert("Tabriklaymiz! Ma'lumotlar saqlandi.");
            // DIQQAT: Bu yerda ham backtick ishlatamiz
            window.location.href = `profile.html?id=${cardId}`;
        }
    } catch (err) {
        alert("Kutilmagan xato: " + err.message);
        btn.disabled = false;
        btn.innerText = "SAQLASH";
    }
};