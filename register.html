<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body style="background:#121212; color:white; font-family:sans-serif; text-align:center; padding-top:50px;">

    <h2>Karta Faollashtirish</h2>
    <input type="text" id="name" placeholder="Ism"><br><br>
    <input type="tel" id="phone" placeholder="Telefon"><br><br>
    <input type="text" id="telegram" placeholder="Telegram"><br><br>
    <button id="btn" style="padding:10px 40px; background:#00d2ff; border:none; border-radius:5px; cursor:pointer;">SAQLASH</button>

    <script>
        const SB_URL = "https://vakuoatitkvxgkkyhzyi.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZha3VvYXRpdGt2eGdra3loenlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3OTY3MjgsImV4cCI6MjA4NjM3MjcyOH0.-gERCw7PtwYZLM78SMs7_OLM5tLkaM8qVpmmQ_joMEo";
        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        document.getElementById('btn').onclick = async () => {
            const cardId = new URLSearchParams(window.location.search).get('id');
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            const telegram = document.getElementById('telegram').value;

            if(!cardId) {
                alert("XATO: URL-da id topilmadi!");
                return;
            }

            document.getElementById('btn').innerText = "Kuting...";
            document.getElementById('btn').disabled = true;

            const { error } = await _supabase.from('users').insert([{ 
                id: cardId, 
                qr_code: cardId, 
                name: name, 
                phone: phone, 
                telegram: telegram, 
                image_url: "https://ui-avatars.com/api/?name=" + name
            }]);

            if (error) {
                // Agar 23505 xatosi chiqsa - demak bu ID bazada bor
                alert("XATO: " + error.message);
                document.getElementById('btn').innerText = "SAQLASH";
                document.getElementById('btn').disabled = false;
            } else {
                alert("SAQLANDI!");
                window.location.href = "profile.html?id=" + cardId;
            }
        };
    </script>
</body>
</html>